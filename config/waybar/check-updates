#!/bin/bash

# Check if command exists
command_exists() {
    command -v "$1" &>/dev/null
}

# Prevent overlapping instances
SCRIPT_NAME=$(basename "$0")
INSTANCE_COUNT=$(pgrep -fc "$SCRIPT_NAME")
if [ "$INSTANCE_COUNT" -gt 1 ]; then
    sleep "$INSTANCE_COUNT"
fi

# Thresholds for status colors
THRESHOLD_GREEN=0
THRESHOLD_YELLOW=25
THRESHOLD_RED=100

# Wait for pacman to unlock
while [ -f "/var/lib/pacman/db.lck" ] || [ -f "${TMPDIR:-/tmp}/checkup-db-${UID}/db.lck" ]; do
    sleep 1
done

# Count official repo updates
total_updates=$(checkupdates 2>/dev/null | wc -l)

# Add AUR updates if available
if command_exists "paru"; then
    aur_updates=$(paru -Qua 2>/dev/null | wc -l)
    total_updates=$((total_updates + aur_updates))
fi

# Set color based on count
css_class="green"
if [ "$total_updates" -gt "$THRESHOLD_RED" ]; then
    css_class="red"
elif [ "$total_updates" -gt "$THRESHOLD_YELLOW" ]; then
    css_class="yellow"
fi

# Output JSON for status bar
if [ "$total_updates" -gt "$THRESHOLD_GREEN" ]; then
    printf '{"text": "%s", "alt": "%s", "tooltip": "Click to update your system", "class": "%s"}' "$total_updates" "$total_updates" "$css_class"
else
    printf '{"text": "0", "alt": "0", "tooltip": "No updates available", "class": "green"}'
fi
