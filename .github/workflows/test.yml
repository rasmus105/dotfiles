name: Test Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run ShellCheck
        run: |
          # Install shellcheck if not available
          sudo apt-get update && sudo apt-get install -y shellcheck
          
          echo "Checking shell scripts..."
          
          # Check main scripts
          shellcheck install.sh || true
          shellcheck common.sh || true
          
          # Check install scripts
          for script in install/*.sh; do
            echo "Checking $script"
            shellcheck "$script" || true
          done
          
          # Check test scripts
          for script in test/*.sh; do
            echo "Checking $script"
            shellcheck "$script" || true
          done
          
          # Check common scripts
          for script in common/*.sh; do
            echo "Checking $script"
            shellcheck "$script" || true
          done
          
          # Check bin scripts (they may not have .sh extension)
          for script in bin/*; do
            if file "$script" | grep -q "shell script"; then
              echo "Checking $script"
              shellcheck "$script" || true
            fi
          done
          
          echo "ShellCheck complete"

  docker-test:
    name: Docker Installation Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build base image
        run: |
          docker build \
            --target base \
            --tag dotfiles-test-base \
            --file test/Dockerfile \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            .
      
      - name: Build test image
        run: |
          docker build \
            --tag dotfiles-test \
            --file test/Dockerfile \
            --cache-from type=gha \
            .
      
      - name: Run installation test
        run: |
          # Make test script executable
          chmod +x test/docker-test.sh
          
          # Run test with local mode (uses repo copy)
          ./test/docker-test.sh --local
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: installation-logs
          path: install/log/
          retention-days: 7

  docker-test-github-clone:
    name: Docker Test (GitHub Clone)
    runs-on: ubuntu-latest
    # Only run on main branch to test actual user experience
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and test with GitHub clone
        run: |
          chmod +x test/docker-test.sh
          
          # Test by cloning from GitHub (simulates real user)
          ./test/docker-test.sh

  validate-packages:
    name: Validate Package List
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate packages.txt
        run: |
          echo "Validating package list format..."
          
          # Check for syntax errors
          grep -v '^#' install/packages.txt | grep -v '^$' | while read -r pkg; do
            # Check for invalid characters
            if echo "$pkg" | grep -qE '[^a-zA-Z0-9._+-]'; then
              echo "Warning: Package name may be invalid: $pkg"
            fi
          done
          
          # Count packages
          count=$(grep -v '^#' install/packages.txt | grep -v '^$' | wc -l)
          echo "Total packages to install: $count"

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for required documentation
        run: |
          echo "Checking for required documentation files..."
          
          files=(
            "README.md"
            "ARCHITECTURE.md"
            "DESIGN_REVIEW.md"
            "CONTRIBUTING.md"
          )
          
          missing=0
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              missing=$((missing + 1))
            else
              echo "✓ Found: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "Error: $missing required documentation file(s) missing"
            exit 1
          fi
          
          echo "All required documentation files present"
      
      - name: Validate markdown links
        run: |
          echo "Checking for broken internal links in README.md..."
          
          # This is a simple check - could be enhanced with a proper link checker
          if grep -oP '\[.*?\]\(#.*?\)' README.md; then
            echo "Internal links found in README"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Scan for secrets
        run: |
          echo "Scanning for potential secrets..."
          
          # Simple secret scanning (could use tools like gitleaks or trufflehog)
          if grep -r -i "password\|api_key\|secret\|token" \
             --exclude-dir=.git \
             --exclude-dir=themes \
             --exclude="*.md" \
             --exclude="test.yml" \
             . ; then
            echo "⚠️ Warning: Potential secrets or credentials found"
            echo "Review the above matches to ensure no real secrets are committed"
          else
            echo "✓ No obvious secrets detected"
          fi
      
      - name: Check for NOPASSWD sudo
        run: |
          echo "Checking for passwordless sudo configuration..."
          
          if grep -r "NOPASSWD" --exclude-dir=.git --exclude-dir=test .; then
            echo "⚠️ Warning: NOPASSWD sudo found outside test directory"
            echo "This should only be in test environments"
            exit 1
          else
            echo "✓ NOPASSWD sudo only in test directory (OK)"
          fi

  report-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, docker-test, validate-packages, documentation-check, security-scan]
    if: always()
    
    steps:
      - name: Report results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.shellcheck.result }}" == "success" ]; then
            echo "✅ ShellCheck passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ ShellCheck failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.docker-test.result }}" == "success" ]; then
            echo "✅ Docker test passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Docker test failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-packages.result }}" == "success" ]; then
            echo "✅ Package validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Package validation failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.documentation-check.result }}" == "success" ]; then
            echo "✅ Documentation check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Documentation check failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "✅ Security scan passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Security scan failed" >> $GITHUB_STEP_SUMMARY
          fi
