#!/bin/bash
set -e

# Trap errors to provide debugging info
trap 'notify-send --urgency critical "Failed to change shell" "Command '\''$BASH_COMMAND'\'' exited with code $?"; exit 1' ERR

shell_name="$1"

# Validate input
if [[ -z "$shell_name" ]]; then
    echo "Usage: system-set-shell <shell-name>"
    echo "Available shells: zsh, bash, fish"
    exit 1
fi

# Normalize shell name to lowercase
shell_name="${shell_name,,}"

# Check if shell is valid
case "$shell_name" in
zsh | bash | fish) ;;
*)
    notify-send "Invalid shell: '$shell_name'" "Available shells: zsh, bash, fish"
    exit 1
    ;;
esac

# Get the shell's full path
shell_path=$(which "$shell_name" 2>/dev/null)

if [[ -z "$shell_path" ]]; then
    notify-send "Shell '$shell_name' not found" "Please install $shell_name first"
    exit 1
fi

# Check if shell is in /etc/shells
if ! grep -q "^${shell_path}$" /etc/shells; then
    notify-send "Shell not in /etc/shells" "$shell_path is not listed in /etc/shells"
    exit 1
fi

# Get current shell
current_shell=$(getent passwd "$USER" | cut -d: -f7)

# Check if we're already using this shell
if [[ "$current_shell" == "$shell_path" ]]; then
    notify-send "Already using $shell_name" "Your default shell is already $shell_name"
    exit 0
fi

# Change the shell
sudo chsh -s "$shell_path"
notify-send "Shell changed to $shell_name" "Please log out and log back in for changes to take effect"
