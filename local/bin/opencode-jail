#!/bin/zsh

# OpenCode firejail wrapper
# Runs opencode in a sandboxed environment with proper config access
#
# Very important to NOT use private /dev, as that will screw up the input of neovim inside of opencode.

local cwd="${1:-$PWD}"
if [[ $# -ge 1 ]] && [ -d "$1" ]; then
    cwd="$(realpath "$1")"
    shift
else
    cwd="$PWD"
fi

# Paths that need read-write access
JAIL_RW=(
    "$HOME/.config/opencode"
    "$HOME/.opencode"
    "$HOME/.local/share/opencode"
    "$HOME/.local/state/opencode"
    "$HOME/.cache/opencode"
    "$HOME/.dotfiles/config/opencode"  # symlink target for config
    "$HOME/.gitconfig"
    "$HOME/.ssh"
    "$cwd"
)

# Language toolchains (add if they exist)
[ -d "$HOME/.cargo" ] && JAIL_RW+=("$HOME/.cargo")
[ -d "$HOME/.rustup" ] && JAIL_RW+=("$HOME/.rustup")
[ -d "$HOME/.npm" ] && JAIL_RW+=("$HOME/.npm")
[ -d "$HOME/.local/share/npm" ] && JAIL_RW+=("$HOME/.local/share/npm")
[ -d "$HOME/.bun" ] && JAIL_RW+=("$HOME/.bun")
[ -d "$HOME/.deno" ] && JAIL_RW+=("$HOME/.deno")
[ -d "$HOME/go" ] && JAIL_RW+=("$HOME/go")
[ -d "$HOME/.go" ] && JAIL_RW+=("$HOME/.go")
[ -d "$HOME/.cache/go-build" ] && JAIL_RW+=("$HOME/.cache/go-build")
[ -d "$HOME/.pyenv" ] && JAIL_RW+=("$HOME/.pyenv")
[ -d "$HOME/.local/share/virtualenvs" ] && JAIL_RW+=("$HOME/.local/share/virtualenvs")
[ -d "$HOME/.conda" ] && JAIL_RW+=("$HOME/.conda")
[ -d "$HOME/.local/pipx" ] && JAIL_RW+=("$HOME/.local/pipx")
[ -d "$HOME/.cache/pip" ] && JAIL_RW+=("$HOME/.cache/pip")
[ -d "$HOME/.java" ] && JAIL_RW+=("$HOME/.java")
[ -d "$HOME/.gradle" ] && JAIL_RW+=("$HOME/.gradle")
[ -d "$HOME/.m2" ] && JAIL_RW+=("$HOME/.m2")
[ -d "$HOME/.local/bin" ] && JAIL_RW+=("$HOME/.local/bin")
[ -d "$HOME/.platformio" ] && JAIL_RW+=("$HOME/.platformio")
[ -d "$HOME/.pnpm" ] && JAIL_RW+=("$HOME/.pnpm")
[ -d "$HOME/.local/share/pnpm" ] && JAIL_RW+=("$HOME/.local/share/pnpm")
[ -d "$HOME/.yarn" ] && JAIL_RW+=("$HOME/.yarn")
[ -d "$HOME/.cache/zig" ] && JAIL_RW+=("$HOME/.cache/zig")

# Paths that need read-only access (system libraries, etc.)
JAIL_RO=()
[ -d "/usr/lib/zig" ] && JAIL_RO+=("/usr/lib/zig")

# Neovim (for editor integration)
[ -d "$HOME/.config/nvim" ] && JAIL_RW+=("$HOME/.config/nvim")
[ -d "$HOME/.local/share/nvim" ] && JAIL_RW+=("$HOME/.local/share/nvim")
[ -d "$HOME/.local/state/nvim" ] && JAIL_RW+=("$HOME/.local/state/nvim")
[ -d "$HOME/.cache/nvim" ] && JAIL_RW+=("$HOME/.cache/nvim")
[ -d "$HOME/.vim" ] && JAIL_RW+=("$HOME/.vim")

# Lazygit
[ -d "$HOME/.config/lazygit" ] && JAIL_RW+=("$HOME/.config/lazygit")

# Build the firejail command
JAIL="firejail --noprofile"
JAIL="$JAIL --caps.drop=all --nonewprivs --seccomp --noroot"

# kcov uses ptrace/process_vm_readv; Firejail seccomp blocks these unless allowed.
if command -v kcov >/dev/null 2>&1; then
    JAIL="$JAIL --allow-debuggers"
fi

JAIL="$JAIL --nodvd --notv --novideo --nosound --noinput"
JAIL="$JAIL --private-tmp"
JAIL="$JAIL --read-only=\"$HOME\""

for jp in "${JAIL_RW[@]}"; do
    [ -e "$jp" ] && JAIL="$JAIL --read-write=\"$jp\""
done

for jp in "${JAIL_RO[@]}"; do
    [ -e "$jp" ] && JAIL="$JAIL --read-only=\"$jp\""
done

pushd -q "$cwd"
eval $JAIL --env=OPENCODE_CONFIG="$HOME/.config/opencode/all-access.json" opencode "$@"
popd -q
