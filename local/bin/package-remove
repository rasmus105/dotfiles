#!/bin/bash
source "$HOME/.local/lib/shell/common.sh"

fzf_args=(
    --multi
    --preview 'paru -Qi {1}'
    --preview-label='Space/Tab: select, Enter: confirm, Ctrl-p: toggle preview, Ctrl-f/b: scroll packages'
    --preview-label-pos='bottom'
    --preview-window 'right:60%:wrap'
    --bind 'ctrl-p:toggle-preview'
    --bind 'ctrl-d:preview-half-page-down,ctrl-u:preview-half-page-up'
    --bind 'ctrl-f:half-page-down,ctrl-b:half-page-up'
    --bind 'space:toggle'
    --bind 'ctrl-space:toggle'
    --color 'pointer:red,marker:red'
    --header='Select packages to remove'
)

# Select packages with FZF
selected=$(paru -Qqe | fzf "${fzf_args[@]}")

if [[ -z "$selected" ]]; then
    gum_warning "No packages selected"
    exit 0
fi

# Show what will be removed
pkg_count=$(echo "$selected" | wc -l)
echo
gum style --foreground "$GUM_COLOR_ERROR" --bold "Removing $pkg_count package(s):"
echo "$selected" | while read -r pkg; do
    gum style --foreground "$GUM_COLOR_ERROR" "  âœ— $pkg"
done
echo

# Confirm removal
if ! gum_confirm "Remove these packages?"; then
    gum_info "Cancelled"
    exit 0
fi

# Remove packages with log_run
pkg_list=$(echo "$selected" | tr '\n' ' ')
log_run "Removing packages" "sudo pacman -Rns --noconfirm $pkg_list"

if [[ $? -eq 0 ]]; then
    gum_show
fi
