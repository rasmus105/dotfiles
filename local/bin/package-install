#!/bin/bash
source "$HOME/.local/lib/shell/common.sh"

format_packages() {
    awk '{
        colors["core"] = "\033[34m"
        colors["extra"] = "\033[32m"
        colors["aur"] = "\033[33m"
        color = ($1 in colors) ? colors[$1] : "\033[0m"
        installed = ($4 == "[installed]") ? " \033[90mâœ“\033[0m" : ""
        printf "%s[%s]\033[0m %s%s\n", color, $1, $2, installed
    }'
}

fzf_args=(
    --multi
    --ansi
    --preview 'paru -Si {2}'
    --preview-label='Space/Tab: select, Enter: confirm, Ctrl-p: toggle preview, Ctrl-f/b: scroll packages'
    --preview-label-pos='bottom'
    --preview-window 'right:60%:wrap'
    --bind 'ctrl-p:toggle-preview'
    --bind 'ctrl-d:preview-half-page-down,ctrl-u:preview-half-page-up'
    --bind 'ctrl-f:half-page-down,ctrl-b:half-page-up'
    --bind 'space:toggle'
    --bind 'ctrl-space:toggle'
    --color 'pointer:green,marker:green'
    --header='Select packages to install'
)

# Select packages with FZF
# paru contains a bug causing it to crash at the moment.
# selected=$(paru -Sl | format_packages | fzf "${fzf_args[@]}" | awk '{print $2}')
selected=$(pacman -Sl | format_packages | fzf "${fzf_args[@]}" | awk '{print $2}')

if [[ -z "$selected" ]]; then
    gum_warning "No packages selected"
    exit 0
fi

# Show what will be installed
pkg_count=$(echo "$selected" | wc -l)
echo
gum style --foreground "$GUM_COLOR_SUCCESS" --bold "Installing $pkg_count package(s):"
echo "$selected" | while read -r pkg; do
    gum style --foreground "$GUM_COLOR_SUCCESS" "  + $pkg"
done
echo

# Confirm installation
if ! gum_confirm "Install these packages?"; then
    gum_info "Cancelled"
    exit 0
fi

# Install packages with log_run
pkg_list=$(echo "$selected" | tr '\n' ' ')
log_run "Installing packages" "paru -S --noconfirm $pkg_list"

if [[ $? -eq 0 ]]; then
    log_run "Updating file database" "sudo updatedb"
    gum_show
fi
