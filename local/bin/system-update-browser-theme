#!/bin/bash
command_present() {
    command -v "$1" &>/dev/null
}

BROWSER_THEME=~/.config/theme/browser.theme

if command_present chromium || command_present helium-browser; then
    if [[ -f $BROWSER_THEME ]]; then
        THEME_RGB_COLOR=$(<$BROWSER_THEME)
        THEME_HEX_COLOR=$(printf '#%02x%02x%02x' ${THEME_RGB_COLOR//,/ })
    else
        # Use a default, neutral grey if theme doesn't have a color
        THEME_RGB_COLOR="28,32,39"
        THEME_HEX_COLOR="#1c2027"
    fi

    if command_present chromium; then
        rm -f /etc/chromium/policies/managed/color.json
        chromium --no-startup-window --set-theme-color="$THEME_RGB_COLOR"

        if [[ -f ~/.config/theme/light.mode ]]; then
            chromium --no-startup-window --set-color-scheme="light"
        else
            chromium --no-startup-window --set-color-scheme="dark"
        fi
    fi

    if command_present helium-browser; then
        echo "{\"BrowserThemeColor\": \"$THEME_HEX_COLOR\"}" | sudo tee "/etc/chromium/policies/managed/color.json" >/dev/null
        helium-browser --no-startup-window --refresh-platform-policy
    fi
fi
