#!/usr/bin/env bash
set -euo pipefail

#──────────────────────────────────────────────────────────────────────────────
# Setup
#──────────────────────────────────────────────────────────────────────────────

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../lib/shell/common.sh" 2>/dev/null || q() { "$@" >/dev/null 2>&1; }
source "${SCRIPT_DIR}/../lib/shell/completions.sh" 2>/dev/null || true

THEME_DIR="$HOME/.config/theme"

#──────────────────────────────────────────────────────────────────────────────
# Command Definitions (for completions and help)
#──────────────────────────────────────────────────────────────────────────────

declare -gA COMMANDS=(
    [all]="Refresh everything (apps + reload configs) [default]"
    [apps]="Restart system applications"
    [theme]="Reload applications to pick up theme/config changes"
    [app]="Restart specific application with optional arguments"
    [help]="Show this help"
)

#──────────────────────────────────────────────────────────────────────────────
# Functions
#──────────────────────────────────────────────────────────────────────────────

main() {
    # Handle completions first
    if handle_completions "$@"; then
        exit 0
    fi
    # If --completions was specified but failed, exit with error
    [[ "${1:-}" == "--completions" ]] && exit 1

    parse_args "$@"
}

parse_args() {
    # Default action if no arguments
    if [[ $# -eq 0 ]]; then
        refresh_all
        exit 0
    fi

    local action="$1"
    shift

    case "$action" in
    all)
        [[ $# -eq 0 ]] || {
            echo "Error: all takes no arguments" >&2
            exit 1
        }
        refresh_all
        ;;
    apps)
        [[ $# -eq 0 ]] || {
            echo "Error: apps takes no arguments" >&2
            exit 1
        }
        refresh_apps
        ;;
    theme)
        [[ $# -eq 0 ]] || {
            echo "Error: theme takes no arguments" >&2
            exit 1
        }
        refresh_theme
        ;;
    app)
        [[ $# -ge 1 ]] || {
            echo "Error: app requires application name" >&2
            exit 1
        }
        restart_app "$@"
        ;;
    --help | -h | help)
        [[ $# -eq 0 ]] || {
            echo "Error: help takes no arguments" >&2
            exit 1
        }
        print_help
        ;;
    *)
        echo "Error: Unknown action: $action" >&2
        print_help
        exit 1
        ;;
    esac
}

#──────────────────────────────────────────────────────────────────────────────
# Refresh Functions
#──────────────────────────────────────────────────────────────────────────────

refresh_all() {
    refresh_apps
    refresh_theme

    # Sync filesystem to ensure clean state
    q sync

    echo "System refreshed"
}

refresh_apps() {
    # Restart apps
    restart_app elephant || true
    restart_app walker --gapplication-service || true
    restart_app mako || true
    # restart_app kanshi || true

    echo "Apps refreshed"
}

restart_app() {
    # Parse options
    local only_if_running=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
        --only-if-running)
            only_if_running=true
            shift
            ;;
        *)
            break
            ;;
        esac
    done

    # Check if app name is provided
    if [[ $# -eq 0 ]]; then
        echo "Error: No application name provided" >&2
        return 1
    fi

    local app_name="$1"
    shift # Remove app name, leaving optional args in $@

    # Check if app is currently running
    local is_running=false
    if pgrep -x "$app_name" >/dev/null 2>&1; then
        is_running=true
    fi

    # If --only-if-running is set and app is not running, exit silently
    if [[ "$only_if_running" == true ]] && [[ "$is_running" == false ]]; then
        return 0
    fi

    # Kill the app if it's running
    if [[ "$is_running" == true ]]; then
        q pkill -x "$app_name" || true
    fi

    # Start the app with any additional arguments
    q setsid uwsm app -- "$app_name" "$@" &

    echo "Restarted $app_name"
}

refresh_theme() {
    restart_app --only-if-running waybar || true

    # Reload compositor
    q hyprctl reload || true

    # Reload system services
    restart_app swayosd-server || true
    q makoctl reload || true

    # Reload terminals (picks up all config changes including theme)
    reload_terminals

    # Reload btop
    q pkill -SIGUSR2 btop || true

    # Shuffle background
    q system-theme background shuffle || true

    echo "Theme refreshed"
}

#──────────────────────────────────────────────────────────────────────────────
# Application Reload Functions
#──────────────────────────────────────────────────────────────────────────────

reload_terminals() {
    # Alacritty: touch config to trigger reload
    if [[ -f "$HOME/.config/alacritty/alacritty.toml" ]]; then
        q touch "$HOME/.config/alacritty/alacritty.toml" || true
    fi

    # Ghostty: send SIGUSR2 to reload configuration
    q killall -SIGUSR2 ghostty || true
}

#──────────────────────────────────────────────────────────────────────────────
# Help Functions
#──────────────────────────────────────────────────────────────────────────────

print_help() {
    cat <<EOF
Usage: system-refresh [command] [arguments]

Commands:
EOF
    # Generate commands from COMMANDS array
    for cmd in "${!COMMANDS[@]}"; do
        printf "  %-18s %s\n" "$cmd" "${COMMANDS[$cmd]}"
    done | sort

    cat <<EOF

Options for 'app' command:
  --only-if-running  Only restart if already running

Examples:
  system-refresh                              # Refresh everything
  system-refresh apps                         # Just restart apps
  system-refresh theme                        # Reload apps to pick up config changes
  system-refresh app waybar                   # Restart waybar
  system-refresh app --only-if-running waybar # Restart waybar only if running
  system-refresh app walker --gapplication-service

Note: To set a theme, use 'system-theme set THEME' which will automatically refresh
EOF
}

main "$@"
